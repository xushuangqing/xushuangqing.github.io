
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>iOS 14 -[UIInputResponderController prepareToMoveKeyboardForInputViewSet:animationStyle:] crash è§£å†³ | å–èŒå‡‰</title>
<meta name="description" content="&lt;p&gt;iOSå¼€å‘è€…&lt;/p&gt;
&lt;p&gt;æ¯•ä¸šäºæ¸…åå¤§å­¦è®¡ç®—æœºç³»&lt;/p&gt;
&lt;p&gt;ç›®å‰ä¾›èŒäºå­—èŠ‚è·³åŠ¨&lt;/p&gt;
&lt;p&gt;â€”&lt;/p&gt;
&lt;p&gt;å¦‚æœä½ æƒ³äº†è§£æˆ‘çš„ç”Ÿæ´»ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼šæ•£æ­¥æ—¥å†&lt;/p&gt;">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://xushuangqing.github.io/favicon.ico?v=1651302178129">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://xushuangqing.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://xushuangqing.github.io">
        <img class="avatar" src="https://xushuangqing.github.io/images/avatar.png?v=1651302178129" alt="" width="32px" height="32px">
      </a>
      <a href="https://xushuangqing.github.io">
        <h1 class="site-title">å–èŒå‡‰</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">iOS 14 -[UIInputResponderController prepareToMoveKeyboardForInputViewSet:animationStyle:] crash è§£å†³</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2020-07-12</span>
            
          </div>
          <div class="post-content">
            <h1 id="é—®é¢˜">é—®é¢˜</h1>
<p>7 æœˆ 8 æ—¥ iOS 14 beta 2 æ”¾å‡ºåï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ä¸€ä¸ª crash æ¿€å¢äº†èµ·æ¥ã€‚</p>
<p>è¿™ä¸ª crash é¡¶éƒ¨çš„å †æ ˆä¸ºï¼š</p>
<pre><code>0        _objc_retain (in libobjc.A.dylib)
1        -[UIInputResponderController prepareToMoveKeyboardForInputViewSet:animationStyle:] (in UIKitCore)
2        -[UIInputResponderController setKeyWindowSceneInputViews:animationStyle:] (in UIKitCore)
3        -[UIInputResponderController setInputViews:animationStyle:] (in UIKitCore)
4        -[UIInputResponderController setInputViews:animated:] (in UIKitCore)
5        -[UIInputResponderController setInputViews:] (in UIKitCore)
......
</code></pre>
<p>å¹¶ä¸”æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œè¿™ä¸ªé—®é¢˜çš„è§¦å‘ï¼Œå’Œä¸šåŠ¡å½¢æ€æ²¡æœ‰ç‰¹åˆ«å¯†åˆ‡çš„è”ç³»ï¼Œå¤šä¸ª app éƒ½é‡åˆ°äº†è¿™ä¸ªå´©æºƒï¼Œä¸”é‡çº§ä¸ä½ã€‚</p>
<h1 id="ä¿®å¤æ–¹æ¡ˆ">ä¿®å¤æ–¹æ¡ˆ</h1>
<p>å…ˆæŠ›å‡ºä¸€ä¸‹æˆ‘ä»¬æœ€åç¡®å®šçš„ä¿®å¤æ–¹æ¡ˆï¼š</p>
<p>hook ç§æœ‰æ–¹æ³• <code>-[UIInputViewSet restorableResponder]</code>ï¼Œç›´æ¥è¿”å› <code>nil</code>ã€‚</p>
<p>ç”±äºæ˜¯ç³»ç»Ÿåº“è‡ªèº«çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ²¡æœ‰æºç ï¼Œå¾ˆéš¾ä¿è¯è¿™ä¸ªä¿®å¤æ²¡æœ‰å¼•å…¥æ–°çš„å‘ã€‚ä½†ä»ç›®å‰çš„æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œè‡³å°‘å´©æºƒä¸å†å¤ç°äº†ï¼Œå¹¶ä¸”çœ‹èµ·æ¥æœ‰å…³è”çš„é”®ç›˜åœºæ™¯ï¼Œä¹Ÿæ²¡æœ‰ä¸¥é‡é—®é¢˜ã€‚</p>
<h1 id="åŸå› å®šä½">åŸå› å®šä½</h1>
<p>é€ æˆ crash çš„åŸå› ï¼Œæ˜¯ç³»ç»Ÿç§æœ‰ç±» <code>UIInputViewSet</code> ä¸­çš„ <code>restorableResponder</code> å±æ€§ï¼Œæ—¢ä¸æ˜¯ weak ä¹Ÿä¸æ˜¯ strongï¼Œç±»ä¼¼äº unsafe_unretainedã€‚æ‰€ä»¥å½“å®ƒè¢«è®¿é—®æ—¶ï¼Œå¾ˆå®¹æ˜“é€ æˆé‡æŒ‡é’ˆã€‚å½“å®ƒè¢«èµ‹å€¼ç»™ä¸€ä¸ª <code>__strong id</code> ç±»å‹çš„å˜é‡æ—¶ï¼Œåˆ™ä¼šåœ¨ <code>_objc_retain</code> ä¸­å´©æºƒã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ‰“ç¬¦å·æ–­ç‚¹ï¼Œä»æ±‡ç¼–ä¸­ç¡®è®¤ï¼Œ iOS 14 beta 2 ä¸­ï¼ŒrestorableResponder å±æ€§çš„ getter å’Œ setter æ–¹æ³•ï¼Œåªæ˜¯å­˜å–äº†ä¸€ä¸ªå†…å­˜å€¼ï¼Œæ²¡æœ‰åšä»»ä½• weak æˆ– strong åº”æœ‰çš„æ“ä½œã€‚</p>
<p><img src="https://xushuangqing.github.io/post-images/iOS-14---%5BUIInputResponderController-prepareToMoveKeyboardForInputView/164542-fccf065a692031aa.png" alt="" loading="lazy"><br>
<img src="https://xushuangqing.github.io/post-images/iOS-14---%5BUIInputResponderController-prepareToMoveKeyboardForInputView/164542-e8ce966189f633a9.png" alt="" loading="lazy"><br>
ï¼ˆä»æ±‡ç¼–æŒ‡ä»¤çœ‹ï¼Œæ²¡æœ‰ storeWeak æˆ– storeStrong æ“ä½œï¼‰</p>
<p>å¯ä»¥ hook  <code>-[UIInputViewSet restorableResponder]</code> æ–¹æ³•ï¼ŒéªŒè¯ä¸€ä¸‹å®ƒçš„è¿”å›å€¼æ˜¯ä¸æ˜¯ç»å¸¸æ˜¯ä¸ªé‡æŒ‡é’ˆã€‚</p>
<h1 id="å®šä½è¿‡ç¨‹">å®šä½è¿‡ç¨‹</h1>
<p>æ˜¯æ€ä¹ˆå®šä½åˆ° <code>-[UIInputViewSet restorableResponder]</code> æ–¹æ³•çš„å‘¢ï¼Ÿæˆ‘çš„æ€è·¯æ˜¯è¿™æ ·çš„ï¼š</p>
<p>1ã€çŒœæµ‹é—®é¢˜æ¥æºäºæœ€é¡¶æ ˆ Â <code>-[UIInputResponderController prepareToMoveKeyboardForInputViewSet:animationStyle:] (in UIKitCore)</code> çš„å‚æ•°</p>
<p>2ã€hook <code>-[UIInputResponderController prepareToMoveKeyboardForInputViewSet:animationStyle:]</code> æ–¹æ³•ï¼Œè·å–ä¼ å…¥çš„å‚æ•°ï¼Œå‘ç°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹æ˜¯ UIInputViewSetï¼Œè¿™ä¸¤ä¸ªå‚æ•°æœ¬èº«ä¸æ˜¯é‡æŒ‡é’ˆã€‚</p>
<p>3ã€hook <code>-[UIInputResponderController prepareToMoveKeyboardForInputViewSet:animationStyle:]</code>ï¼Œå°è¯•å°†ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°æ”¹æˆ nilï¼Œå‘ç° crash ä¸å¤ç°äº†ã€‚è¿™åŸºæœ¬å¯ä»¥ç¡®è®¤é—®é¢˜å‡ºåœ¨å‚æ•°ä¸Šã€‚ä½†å‚æ•°æœ¬èº«ä¸æ˜¯é‡æŒ‡é’ˆï¼Œæ‰€ä»¥æ¨æµ‹é—®é¢˜å‡ºç°åœ¨å‚æ•°æŸä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¸Šã€‚</p>
<p>4ã€æ ¹æ®ä¸€ä»½æ—§çš„ <a href="https://developer.limneos.net/?ios=11.0&amp;framework=UIKit.framework&amp;header=UIInputViewSet.h">UIInputViewSet å¤´æ–‡ä»¶</a>ï¼Œåœ¨ lldb ä¸­ä¾æ¬¡å¯¹è¿™ä¸ª UIInputViewSet å¯¹è±¡å‘é€æ¶ˆæ¯ã€‚å‘ç°å…¶ä¸­æœ‰ä¸ªå±æ€§ restorableResponderï¼Œåœ¨æ—§ç‰ˆæœ¬ä¸Šæ ‡è®°ä¸º weakï¼Œä½† getter æ–¹æ³• return å‡ºæ¥çš„åœ°å€ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚ä¸¥é‡æ€€ç–‘è¿™æ˜¯ä¸€ä¸ªé‡æŒ‡é’ˆã€‚</p>
<p>5ã€hook <code>-[UIInputViewSet restorableResponder]</code>ï¼Œè¿”å› nilï¼Œcrash ä¸å¤ç°ï¼Œç¡®è®¤é—®é¢˜å‡ºåœ¨ <code>-[UIInputViewSet restorableResponder]</code> æ–¹æ³•ä¸Š</p>
<p>6ã€é€šè¿‡æ±‡ç¼–ç¡®è®¤ <code>restorableResponder</code> åœ¨ iOS 14 beta 2 ä¸Šæ—¢ä¸æ˜¯ strong ä¹Ÿä¸æ˜¯ weak</p>
<p>ç›¸ä¿¡å¾ˆå¤šå›¢é˜Ÿéƒ½é‡åˆ°äº†è¿™ä¸ª crashï¼Œå…ˆå‰åœ¨ç½‘ç»œä¸Šæœç´¢æœªæœï¼Œæš‚ä¸”æŠ›å‡ºæˆ‘çš„è§£å†³æ–¹æ¡ˆï¼Œæ¬¢è¿ä¸å¤§å®¶äº¤æµã€‚<br>
å½“ç„¶æœ€ç»ˆè¿˜æ˜¯ç­‰è‹¹æœçˆ¸çˆ¸çœŸæ­£ä¿®å¤å®ƒ ğŸ˜­</p>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://xushuangqing.github.io/post/cong--Exported-Symbols--ying-yong-yu-bao-da-xiao-you-hua-shuo-dao-fu-hao-bang-ding/">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼šä» Exported Symbols åº”ç”¨äºåŒ…å¤§å°ä¼˜åŒ–è¯´åˆ°ç¬¦å·ç»‘å®š
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan"><p>iOSå¼€å‘è€…</p>
<p>æ¯•ä¸šäºæ¸…åå¤§å­¦è®¡ç®—æœºç³»</p>
<p>ç›®å‰ä¾›èŒäºå­—èŠ‚è·³åŠ¨</p>
<p>â€”</p>
<p>å¦‚æœä½ æƒ³äº†è§£æˆ‘çš„ç”Ÿæ´»ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼šæ•£æ­¥æ—¥å†</p></div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
   | <a class="rss" href="https://xushuangqing.github.io/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
